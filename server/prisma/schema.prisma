// Soom Gaming Database Schema
// PostgreSQL database for gaming marketplace with escrow system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - handles authentication and wallet
model User {
  id            String        @id @default(uuid())
  username      String        @unique
  email         String        @unique
  password      String        // bcrypt hashed
  walletBalance Decimal       @default(0) @db.Decimal(10, 2)
  role          Role          @default(USER)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  listings      Listing[]     @relation("SellerListings")
  bids          Bid[]
  transactions  Transaction[]
}

enum Role {
  USER
  ADMIN
}

// Listing model - gaming accounts/items for sale
model Listing {
  id           String        @id @default(uuid())
  sellerId     String
  title        String
  description  String?
  gameCategory String
  startPrice   Decimal       @db.Decimal(10, 2)
  buyNowPrice  Decimal?      @db.Decimal(10, 2)
  currentBid   Decimal?      @db.Decimal(10, 2)
  status       ListingStatus @default(PENDING)
  endTime      DateTime
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  seller       User          @relation("SellerListings", fields: [sellerId], references: [id])
  bids         Bid[]
  images       Image[]

  @@index([sellerId])
  @@index([status])
  @@index([gameCategory])
}

enum ListingStatus {
  PENDING
  ACTIVE
  SOLD
  DISPUTED
}

// Bid model - auction bids on listings
model Bid {
  id        String   @id @default(uuid())
  listingId String
  bidderId  String
  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  bidder    User     @relation(fields: [bidderId], references: [id])

  @@index([listingId])
  @@index([bidderId])
}

// Transaction model - escrow and wallet transactions
model Transaction {
  id        String            @id @default(uuid())
  userId    String
  amount    Decimal           @db.Decimal(10, 2)
  type      TransactionType
  status    TransactionStatus @default(PENDING)
  reference String?           // Listing ID or external payment ref
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user      User              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
}

enum TransactionType {
  DEPOSIT
  WITHDRAW
  ESCROW_HOLD
  ESCROW_RELEASE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Image model - listing images
model Image {
  id        String   @id @default(uuid())
  url       String
  listingId String
  createdAt DateTime @default(now())

  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}
